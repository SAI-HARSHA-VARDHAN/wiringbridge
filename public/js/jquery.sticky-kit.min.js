/*
 Sticky-kit v1.1.2 | WTFPL | Leaf Corcoran 2015 | http://leafo.net
*/
(function(){var b,f;b=this.jQuery||window.jQuery;f=b(window);b.fn.stick_in_parent=function(d){var A,w,J,n,B,K,p,q,k,E,t;null==d&&(d={});t=d.sticky_class;B=d.inner_scrolling;E=d.recalc_every;k=d.parent;q=d.offset_top;p=d.spacer;w=d.bottoming;null==q&&(q=0);null==k&&(k=void 0);null==B&&(B=!0);null==t&&(t="is_stuck");A=b(document);null==w&&(w=!0);J=function(a,d,n,C,F,u,r,G){var v,H,m,D,I,c,g,x,y,z,h,l;if(!a.data("sticky_kit")){a.data("sticky_kit",!0);I=A.height();g=a.parent();null!=k&&(g=g.closest(k));
if(!g.length)throw"failed to find stick parent";v=m=!1;(h=null!=p?p&&a.closest(p):b("<div />"))&&h.css("position",a.css("position"));x=function(){var c,f,e;if(!G&&(I=A.height(),c=parseInt(g.css("border-top-width"),10),f=parseInt(g.css("padding-top"),10),d=parseInt(g.css("padding-bottom"),10),n=g.offset().top+c+f,C=g.height(),m&&(v=m=!1,null==p&&(a.insertAfter(h),h.detach()),a.css({position:"",top:"",width:"",bottom:""}).removeClass(t),e=!0),F=a.offset().top-(parseInt(a.css("margin-top"),10)||0)-q,
u=a.outerHeight(!0),r=a.css("float"),h&&h.css({width:a.outerWidth(!0),height:u,display:a.css("display"),"vertical-align":a.css("vertical-align"),"float":r}),e))return l()};x();if(u!==C)return D=void 0,c=q,z=E,l=function(){var b,l,e,k;if(!G&&(e=!1,null!=z&&(--z,0>=z&&(z=E,x(),e=!0)),e||A.height()===I||x(),e=f.scrollTop(),null!=D&&(l=e-D),D=e,m?(w&&(k=e+u+c>C+n,v&&!k&&(v=!1,a.css({position:"fixed",bottom:"",top:c}).trigger("sticky_kit:unbottom"))),e<F&&(m=!1,c=q,null==p&&("left"!==r&&"right"!==r||a.insertAfter(h),
h.detach()),b={position:"",width:"",top:""},a.css(b).removeClass(t).trigger("sticky_kit:unstick")),B&&(b=f.height(),u+q>b&&!v&&(c-=l,c=Math.max(b-u,c),c=Math.min(q,c),m&&a.css({top:c+"px"})))):e>F&&(m=!0,b={position:"fixed",top:c},b.width="border-box"===a.css("box-sizing")?a.outerWidth()+"px":a.width()+"px",a.css(b).addClass(t),null==p&&(a.after(h),"left"!==r&&"right"!==r||h.append(a)),a.trigger("sticky_kit:stick")),m&&w&&(null==k&&(k=e+u+c>C+n),!v&&k)))return v=!0,"static"===g.css("position")&&g.css({position:"relative"}),
a.css({position:"absolute",bottom:d,top:"auto"}).trigger("sticky_kit:bottom")},y=function(){x();return l()},H=function(){G=!0;f.off("touchmove",l);f.off("scroll",l);f.off("resize",y);b(document.body).off("sticky_kit:recalc",y);a.off("sticky_kit:detach",H);a.removeData("sticky_kit");a.css({position:"",bottom:"",top:"",width:""});g.position("position","");if(m)return null==p&&("left"!==r&&"right"!==r||a.insertAfter(h),h.remove()),a.removeClass(t)},f.on("touchmove",l),f.on("scroll",l),f.on("resize",
y),b(document.body).on("sticky_kit:recalc",y),a.on("sticky_kit:detach",H),setTimeout(l,0)}};n=0;for(K=this.length;n<K;n++)d=this[n],J(b(d));return this}}).call(this);

var cnt = 0;
function toggletext(a,editbutton){
    $('#'+editbutton).toggle();
    var id = "#toggle"+a;
    if($(id).text() == "Show Reviews"){
        $(id).text('Hide Reviews');
    }
    else{
        $(id).text('Show Reviews');
    }
}
function toggletextadv(a){

    var id = "#advbtn"+a;
    if($(id).text() == "Advertisement"){
        $(id).text('Hide');
    }
    else{
        $(id).text('Advertisement');
    }
}
function maketagsAndadvertisement(c,tags,adv){
    var id = "#tags"+c;
    tags = tags.split(",");
    var html = `<p class="tagcont">`;
    if(tags.length == 1 && tags[0]==""){
        console.log(tags.length);
        html+=`<span class="tagtext">No Tags</span></p>`;
    }
    else{
         for(var i =0;i<tags.length;i++){
            if(tags[i].toLowerCase() == "fake"){
                // fakeCount+=1;
                html += `<span class="tagtext" style="background-color:red;">${tags[i]}</span>&nbsp&nbsp`;
            }
            else{
                // reviewCount+=1;
                html += `<span class="tagtext">${tags[i]}</span>&nbsp&nbsp`;
            }
        }
        html += `</p>`;
    }
    $(id).html(html);
    if(adv == null){
        // console.log(adv);
        var idAdvButton = "advbtn"+c;
        document.getElementById(idAdvButton).disabled = true;
    }
    else if(adv.title == "" && adv.title=="" && adv.advertizing_content == ""){
        var idAdvButton = "advbtn"+c;
        document.getElementById(idAdvButton).disabled = true;
    }
    else if(adv.title == null && adv.title==null && adv.advertizing_content == null){
        var idAdvButton = "advbtn"+c;
        document.getElementById(idAdvButton).disabled = true;
    }
    else{

    }
}
//Delete and Edit Functionalities ....................
function showdelete(cardnum){
    $('.'+cardnum).toggle("slow");
}
function deletecard(cardid){
    
    $.ajax({
        url: "backend.scrapshut.com/api/post/"+cardid.toString(),
        type: "DELETE",
        headers : {
            "API-KEY": "LrUyJbg2.hbzsN46K8ghSgF8LkhxgybbDnGqqYhKM",
            "Authorization": 'JWT ' + window.localStorage.getItem('access_token'),
        },
        
        success:function(){
            console.log('deleted')
        },
        error:function(error){
            console.log(error)
        }
    });
}
function editcard(cardid,textareaid,buttonid,tagforcard,cardadvertisement,subbutton){
    //currently provisions for cards with advertisements are not made.
    $('#'+textareaid).toggle("slow");
    $('#'+textareaid).prop('disabled', false);
    $('#'+buttonid).hide();
    $('#'+subbutton).toggle();
    $('#'+subbutton).click(function(){
        $text=$('#'+textareaid).val();
        if($text!=''){
            dataofcard={"review":$text,"tags":tagforcard.split(','),"advertisement":{}}
            $.ajax({
                url: "https://backend.scrapshut.com/api/post/"+cardid.toString()+"/",
                type: "PUT",
                headers : {
                    "Authorization": 'JWT ' + window.localStorage.getItem('access_token'),
                    "API-KEY": "LrUyJbg2.hbzsN46K8ghSgF8LkhxgybbDnGqqYhKM",
                },
                contentType: 'application/json',
                data: JSON.stringify(dataofcard),
                success: function(data){
                    alert('The review has been successfully edited')
                    location.reload(true)
                    console.log('done')
                },
                error: function(error){
                    console.log(error)
                }
            });
        }else{
            alert('You left it empty therefore it was not saved')
        }
    });
}


$.ajax({
    url: "https://backend.scrapshut.com/user/me",
    type: "GET",
    headers : {
        "Authorization": 'JWT ' + window.localStorage.getItem('access_token'),
        'content-type': 'application/json'
    },
    contentType: 'application/json',
    dataType: 'json',
    data: {},
    /*type: "GET",
    headers : {
            "API-KEY": "LrUyJbg2.hbzsN46K8ghSgF8LkhxgybbDnGqqYhKM"
    },
    contentType: 'application/json',
    dataType: 'json',
    url: 'https://backend.scrapshut.com/api/service/post/',
    data: {},*/
    success: function (data) {
        console.log(data);
        for (let i = 0; i < data.count; i++) {
            cnt+=1;
            let tags = data.results[i].tags.toString();
            var str = `${tags}`;
            if('advertisement' in data.results[i]){
                $("#Result").append(
                    `<div class="card cardy" style="margin-top:40px;width:50vw;">
                        <h5 class="card-header"><span style="float:right" onclick="showdelete('delete${cnt}')"><i  class="fa fa-caret-down" aria-hidden="true"></i></span><p id="tags${cnt}">&nbsp&nbsp&nbspTags: ${str}</p>
                        <span class="delete${cnt}" onclick="deletecard(${data.results[i].id})"><button class="btn-xs btn-danger">Delete</button></span></h5>
                        <div class="card-body">
                        <div class="row">
                        <div class="col-10"><h5 class="card-title"><a target="_blank" href="${data.results[i].url}"> ${data.results[i].url}</a></h5></div>
                        <div class='col-2'> <p style="color:#EF4136"><b>${data.results[i].rate}<i class="fa fa-star" aria-hidden="true"></i></b></p></div>
                        </div>
                        <br/>
                        <div class="row">
                            <div class="col-6">
                                <p style='text-align:left'><button class="btn btn-danger btn" type="button" id="advbtn${cnt}" data-toggle="collapse" data-target="#collapseExample1${cnt}" aria-expanded="false" aria-controls="collapseExample1" onclick="toggletextadv(${cnt})">Advertisement</button></p>
                            </div>
                            <div class="col-6">
                                <p style='text-align:right'><button class="btn btn-primary btn" type="button" data-toggle="collapse" data-target="#collapseExample${cnt}" aria-expanded="false" aria-controls="collapseExample" onclick="toggletext(${cnt},'disAble${cnt}')" id="toggle${cnt}">Show Reviews</button></p>
                            </div>
                        </div>
                        <div class="collapse" id="collapseExample${cnt}">
                            <p><br/><b>${data.results[i].author}</b></p>
                            <p>&nbsp&nbsp&nbspReview: ${data.results[i].review}</p><button style="display:none" id="disAble${cnt}" onclick=editcard('disText${cnt}','disAble${cnt}')>Edit</button>
                            <img src="public/img/ok.png" height="25px" class="select" id="sel${cnt}0" onclick="selected(${cnt},0,${data.results[i].id})"><span class="count"  id="upc${data.results[i].id}"><b> </b></span><img src="public/img/stop.png" height="25px"  class="select" id="sel${cnt}1" onclick="selected(${cnt},1,${data.results[i].id})" style="margin-left:20px;"><span class="counter" id="dc${data.results[i].id}"> </span>
                        </div>
                        
                        <div class="collapse" id="collapseExample1${cnt}">
                            <h4>${data.results[i].advertisement.title}</h4>
                            <p>${data.results[i].advertisement.advertizing_content}</p>
                            <a href='${data.results[i].advertisement.url}' target="_balnk">${data.results[i].advertisement.url}</a>
                        </div>
                        </div>
                    </div><span><textarea placeholder="Write here....." style="display:none" id='disText${cnt}' disabled="disabled"></textarea></span>`
                );
            }else{
                $("#Result").append(
                    `<div class="card cardy" style="margin-top:40px;width:50vw;">
                        <h5 class="card-header"><span style="float:right" onclick="showdelete('delete${cnt}')"><i class="fa fa-caret-down" aria-hidden="true"></i></span><p id="tags${cnt}">&nbsp&nbsp&nbspTags: ${str}</p>
                        <span class="delete${cnt}" onclick="deletecard(${data.results[i].id})" ><button class="btn-xs btn-danger">Delete</button></span></h5>
                        <div class="card-body">
                        <div class="row">
                        <div class="col-10"><h5 class="card-title"><a target="_blank" href="${data.results[i].url}"> ${data.results[i].url}</a></h5></div>
                        <div class='col-2'> <p style="color:#EF4136"><b>${data.results[i].rate}<i class="fa fa-star" aria-hidden="true"></i></b></p></div>
                        </div>
                        <br/>
                        <div class="row">
                            <div class="col-6">
                                <p style='text-align:left'><button class="btn btn-danger btn" type="button" id="advbtn${cnt}" data-toggle="collapse" data-target="#collapseExample1${cnt}" aria-expanded="false" aria-controls="collapseExample1" onclick="toggletextadv(${cnt})">Advertisement</button></p>
                            </div>
                            <div class="col-6">
                                <p style='text-align:right'><button class="btn btn-primary btn" type="button" data-toggle="collapse" data-target="#collapseExample${cnt}" aria-expanded="false" aria-controls="collapseExample" onclick="toggletext(${cnt},'disAble${cnt}')" id="toggle${cnt}">Show Reviews</button></p>
                            </div>
                        </div>
                        <div class="collapse" id="collapseExample${cnt}">
                            <p><br/><b>${data.results[i].author}</b></p>
                            <p>&nbsp&nbsp&nbspReview: ${data.results[i].review}</p><span style="float:right"><button style="display:none" id="disAble${cnt}" onclick=editcard('${data.results[i].id}','disText${cnt}','disAble${cnt}','${data.results[i].tags}','${data.results[i].advertisement}','subbutton${cnt}')>Edit</button><button id="subbutton${cnt}" style="display:none">Submit</button></span>
                            <img src="public/img/ok.png" height="25px" class="select" id="sel${cnt}0" onclick="selected(${cnt},0,${data.results[i].id})"><span class="count"  id="upc${data.results[i].id}"><b> </b></span><img src="public/img/stop.png" height="25px"  class="select" id="sel${cnt}1" onclick="selected(${cnt},1,${data.results[i].id})" style="margin-left:20px;"><span class="counter" id="dc${data.results[i].id}"> </span>
                        </div>
                        </div>
                    </div><span><textarea placeholder="Write here....." style="display:none" id='disText${cnt}' disabled="disabled"></textarea></span>`
                );
            }
            maketagsAndadvertisement(cnt,tags,data.results[i].advertisement);
        }
    },
    error: function(data)
    {
        console.log(data);
    }
});

/*var i=0;
$('.advertisement').click(function(){
    if(i==0){
        $.ajax({
            url: "https://backend.scrapshut.com/user/me",
            type: 'GET',
            dataType: 'json',
            headers: {
                "Authorization": 'JWT ' + window.localStorage.getItem('access_token'),
                'content-type': 'application/json'
            },
            contentType: 'application/json',
            success: function (result) {
                console.log(result);
                $('.detail').toggle("slow");
                i=1;
             },
             error: function (error) {
                 console.log(error)
             }
            });
    }else{
        $('.detail').toggle("slow")
        i=0;
    }
});*/

